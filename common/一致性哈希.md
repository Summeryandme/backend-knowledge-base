# 关于负载均衡
由于单机的并发量和数据量都是有限的，所以大多数情况都会使用多台服务器构成集群来对外提供服务，那么如何分配到来的请求给不同的服务器呢，这也就是负载均衡

目前解决负载均衡的算法有恒多，例如最简单的方式就是引入一个负载均衡层，将外界的请求「轮流」发给内部的所有集群，考虑到每台服务器的性能和配置，也可以引入权重，给配置更好的服务器配置更高的权重，这种算法叫做加权轮询

但是加权轮训的算法无法应对「分布式系统（数据分片系统）」，因为在这种情况下，每一个服务器存的数据是不同的，因此，需要寻求一种可以应对分布式系统的负载均衡算法
# 哈希算法的不足
最容易想到的算法就是哈希算法了，例如分布式系统中有 3 个节点，基于`hash(key) % 3`公式对数据进行映射

但是这样有一个较为难处理的问题，**当节点数量发生变化时**，也就是在对系统进行扩容或者缩容时，会导致映射关系发生变化，从而必须对数据进行迁移，假设总数据条数为 M，哈希算法在面对节点数量变化时，最坏的情况下所有的数据都要进行迁移，迁移规模是 O(M)，成本过高
# 一致性哈希

一致性哈希算法就很好地解决了分布式系统在扩容或者缩容时，发生过多的数据迁移的问题

一致哈希算法也用了取模运算，但与哈希算法不同的是，哈希算法是对节点的数量进行取模运算，而一致哈希算法是对 2^32 进行取模运算，是一个固定的值。

我们可以把一致哈希算法是对 2^32 进行取模运算的结果值组织成一个圆环，就像钟表一样，钟表的圆可以理解成由 60 个点组成的圆，而此处我们把这个圆想象成由 2^32 个点组成的圆，这个圆环被称为哈希环，如下图：

![image.png](https://cdn.nlark.com/yuque/0/2023/png/28316065/1680162195402-62ba00c0-a583-48cf-8e21-af8943aed9fc.png#averageHue=%23f2f2f2&clientId=ua4b3630f-1b8e-4&from=paste&height=373&id=u7b29f4fe&name=image.png&originHeight=527&originWidth=413&originalType=binary&ratio=2.5&rotation=0&showTitle=false&size=46606&status=done&style=none&taskId=u846708c6-e8d0-46dc-aa19-66c870f27e0&title=&width=292.6666717529297)

一致性哈希要进行两步哈希：

1. 对存储节点进行哈希计算，比如根据节点的 IP 地址进行哈希
2. 当对数据进行存储和访问时，对数据进行哈希映射

所以，一致性哈希是指将「存储节点」和「数据」都映射到一个首尾相连的哈希环上。

问题来了，对「数据」进行哈希映射得到一个结果要怎么找到存储该数据的节点呢？

答案是，映射的结果值往顺时针的方向的找到第一个节点，就是存储该数据的节点。

因此，在一致哈希算法中，如果增加或者移除一个节点，仅影响该节点在哈希环上顺时针相邻的后继节点，其它数据也不会受到影响。

但是一致性哈希算法无法保证节点分布的均匀性，在一些不好的情况下，可能会出现大量的请求集中在一个节点的情况，例如：

![image.png](https://cdn.nlark.com/yuque/0/2023/png/28316065/1680162435111-764d63c6-0054-4942-96b5-d1de7facf6e9.png#averageHue=%23f4f0ed&clientId=ua4b3630f-1b8e-4&from=paste&height=334&id=uf9e35dc8&name=image.png&originHeight=530&originWidth=533&originalType=binary&ratio=2.5&rotation=0&showTitle=false&size=109441&status=done&style=none&taskId=uabdb2081-4543-4ee7-9002-75919db196b&title=&width=335.66668701171875)

这个时候可以通过虚拟节点来提高分布的均匀程度，如图：

![image.png](https://cdn.nlark.com/yuque/0/2023/png/28316065/1680162512324-35b0e5bd-04dd-48b1-b1ff-704444ca31b3.png#averageHue=%23f8f3ef&clientId=ua4b3630f-1b8e-4&from=paste&height=343&id=u4db2a02f&name=image.png&originHeight=575&originWidth=563&originalType=binary&ratio=2.5&rotation=0&showTitle=false&size=119505&status=done&style=none&taskId=u418ae34f-e835-4bd9-8f2b-0f36b23a696&title=&width=335.6666717529297)

实际上虚拟节点的数量会很多，这个图只是举个例子，例如 Nginx 的一致性哈希算法，每个权重为 1 的真实节点就含有 160 个虚拟节点，此外，虚拟节点除了会提高节点的均衡度，还会提高系统的稳定性。当节点变化时，会有不同的节点共同分担系统的变化，因此稳定性更高。而且，有了虚拟节点后，还可以为硬件配置更好的节点增加权重，比如对权重更高的节点增加更多的虚拟机节点即可。


