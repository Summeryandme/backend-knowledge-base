### 什么是 127.0.0.1
首先很明显，这是一个 ipv4 地址，其中 127 开头的都属于回环地址，也是 ipv4 的特殊地址
### 什么是 ping
ping 是应用层的命令，可以理解为跟游戏或者聊天软件属于同一层，ping 这个小软件功能比较简单，就是会尝试去发送一个小的消息到目标机器上，判断目标机器是否可达，也就是判断两台机器之间的网络是否连通

ping 的底层使用的是 ICMP 协议，尽管 ICMP 协议和 IP 协议同属于网络层协议，但是 ICMP 协议其实也是利用了 IP 协议进行消息的传输，所以完全可以理解成 ping 某个 ip 就是往某个 ip 发送一个消息
# TCP 发数据和 ping 的区别
比方一个聊天软件用的是 TCP 来发送消息，那么为了发送消息，就得先知道往哪里发，linux 里万物皆文件，那么发送消息的目的地也是一个文件，这里引出 socket 的概念，要使用 socket 首先要创建它，在 TCP 中创建的方式是`socket(AF_INET, SOCK_STREAM, 0)`，其中`AF_INET`表示将使用 ipv4 里 host:port 的方式去解析待会你输入的地址，`SOCK_STREAM`是指面向字节流的 TCP 协议，工作在**传输层**，创建好了 socket 之后，就可以愉快的把要传输的数据写到这个文件里，调用 socket 的`sendto`接口的过程中进程会从用户态进入到内核态，最后会调用`sock_sendmsg`方法

回到 ping，整个过程基本类似，差异点在于创建 socket 的时候用到的命令是`socket(AF_INET, SOCK_RAW, IPPROTO_ICMP)`，`SOCK_RAW`是原始套接字，工作在网络层，所以构建 ICMP 的数据，是再合适不过了
# 为什么断网了也能 ping 通 127.0.0.1
在有网的情况下，ping 是通过网卡将数据发送出去的，那么断网的情况下，网卡已经不工作了，ping 回环地址却一切正常，我们可以看下这种情况下的工作原理

从应用层到传输层再到网络层。这段路径跟 ping 外网的时候是几乎是一样的。到了网络层，系统会根据目的 IP，在路由表中获取对应的路由信息，而这其中就包含选择哪个网卡把消息发出

- 当发现目标 IP 是外网 IP 时，会从"真网卡"发出
- 当发现目标 IP 是回环地址时，就会选择本地网卡
   - 本地网卡其实就是一个“假网卡”，他不像“真网卡”那样有什么 ringbuffer，假网卡会把数据推到一个叫`input_pkt_queue`的链表中，这个链表其实是所有网卡共享的，上面挂着发给本机的各种消息，消息被发送到这个链表之后，会再触发一个软中断，专门处理转中软的的工具人是 `ksoftirqd`，它在收到软中断后就会立马去链表里把消息取出，然后顺着数据链路层、网络层等层层往上传递最后给到应用程序，ping 回环地址和通过 TCP 等各种协议发送数据到回环地址都是走这条路径。整条路径从发到收，都没有经过"真网卡"，之所以 127.0.0.1 叫本地回环地址，可以理解为，消息发出到这个地址上的话，就不会出网络，在本机打个转就又回来了，所以断网，依然能 ping 通 127.0.0.1。


